#!/usr/bin/env ruby
#
# @package EGR (codename)
# @author Luis M. Rodriguez-R <lmrodriguezr at gmail dot com>
# @license artistic license 2.0
# @update Mar-12-2015
#

$:.push File.expand_path(File.dirname(__FILE__) + '/../lib')
require 'egr/project'
require 'optparse'

ARGV << '-h' if ARGV.size==0
o = {:q=>true, :info=>false }
OptionParser.new do |opt|
   opt.banner = <<BAN
Lists all registered datasets in an EGR project.

Usage: #{$0} [options]
BAN
   opt.separator ""
   opt.on("-P", "--project PATH", "(Mandatory) Path to the project to create."){ |v| o[:project]=v }
   opt.on("-i", "--info", "Print additional information on each dataset."){ o[:info]=true }
   opt.on("-v", "--verbose", "Print additional information to STDERR."){ o[:q]=false }
   opt.on("-h", "--help", "Display this screen.") do
      puts opt
      exit
   end
   opt.separator ""
end.parse!


### MAIN
begin
   raise "-P is mandatory." if o[:project].nil?
   
   $stderr.puts "Loading project." unless o[:q]
   p = EGR::Project.load(o[:project])
   raise "Impossible to load project: #{o[:project]}" if p.nil?
   
   $stderr.puts "Listing dataset." unless o[:q]
   if o[:info]
      header = EGR::Dataset.INFO_FIELDS.map{|i| i.ljust(25)}.join("  ")
      puts header, header.gsub(/\S/,'-')
      p.datasets.each{|d| puts d.info.map{|i| i.nil? ? "?" : i.to_s}.map{|i| i.ljust(25)}.join("  ") }
   else
      p.datasets.each{|d| puts d.name}
   end

   $stderr.puts "Done." unless o[:q]
rescue => err
   $stderr.puts "Exception: #{err}\n\n"
   err.backtrace.each { |l| $stderr.puts l + "\n" }
   err
end


